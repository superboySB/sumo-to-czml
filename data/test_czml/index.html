<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 使用正确的字符集 -->
    <meta charset="utf-8">
    <!-- 告诉IE使用最新的渲染模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <!-- 设置视口 -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>CZML Visualization</title>
    <!-- 网站图标 -->
    <link rel="icon" type="image/png" href="../../theme/img/favicon.png" sizes="16x16">
    <!-- 引入CesiumJS库 -->
    <script src="../../ThirdParty/Cesium/Cesium.js"></script>
    <!-- 引入Cesium样式 -->
    <link href="../../ThirdParty/Cesium/Widgets/widgets.css" rel="stylesheet">
    <!-- 引入3DCityDB-Web-Map的相关脚本 -->
    <script src="../../js/3dcitydb-web-map.js"></script>
    <!-- 其他必要的脚本 -->
    <!-- 根据需要添加 -->

    <style>
        html, body, #cesiumContainer {
            top: 0px;
            left: 0px;
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            z-index: -1;
        }

        #uiMenu {
            border-radius: 5px;
            padding: 10px;
            position: absolute;
            left: 20px;
            top: 20px;
            font-family: "Arial";
            z-index: 99999;
            background-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
<div id="cesiumContainer"></div>
<div id="uiMenu">
    <button type="button" onclick="loadCZML()">加载CZML数据</button>
</div>
<script>
    // 输出CesiumJS版本
    console.log('CesiumJS version:', Cesium.VERSION);
    
    // 初始化Cesium Viewer
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlMTg2MGFhOS02YTdhLTQ1NWMtYjkzMi05YjQ2ODRlZjI5YTgiLCJpZCI6MjUxNzM1LCJpYXQiOjE3MzAyODI0ODN9.prWAxx4RB8teelutQQbVqdxhgRZpZ4zjw8wzM-8k1Ug';

    var viewer = new Cesium.Viewer('cesiumContainer', {
        timeline: true,
        animation: true,
        baseLayerPicker: false,
        // **添加以下一行，加载全球地形**
        terrainProvider: Cesium.createWorldTerrain()
    });

    // 创建WebMap3DCityDB对象（如果需要使用3DCityDB-Web-Map的功能）
    var webMap = new WebMap3DCityDB(viewer);

    // 设置初始视图（根据您的数据范围调整）
    viewer.scene.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(11.568953, 48.140915, 500) // 设置相机位置
    });

    // **启用深度测试，确保建筑物与地形正确渲染**
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // 定义一个函数来加载CZML文件
    function loadCZML() {
        // 加载第一个CZML文件（交通流）
        Cesium.CzmlDataSource.load('czml_3Dmodels_sample.czml').then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            // 设置时钟和时间轴
            viewer.clock.multiplier = 1;
            viewer.clock.currentTime = dataSource.clock.currentTime;
            viewer.clock.startTime = dataSource.clock.startTime;
            viewer.clock.stopTime = dataSource.clock.stopTime;
            viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
            viewer.timeline.zoomTo(dataSource.clock.startTime, dataSource.clock.stopTime);

            // 调整视图以适应数据范围
            viewer.flyTo(dataSource);

            // 设置实体的高度参考
            dataSource.entities.values.forEach(function(entity) {
                if (entity.model) {
                    entity.model.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
                }
            });
        }).otherwise(function(error){
            console.error('Error loading czml_3Dmodels_sample.czml:', error);
        });

        // 加载第二个CZML文件（周围建筑）
        Cesium.CzmlDataSource.load('czml_points_sample.czml').then(function(dataSource) {
            viewer.dataSources.add(dataSource);
            // 如果需要，可以调整点的样式
            dataSource.entities.values.forEach(function(entity) {
                if (entity.point) {
                    entity.point.pixelSize = 5;
                    entity.point.color = Cesium.Color.RED;
                    entity.point.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
                }
            });
        }).otherwise(function(error){
            console.error('Error loading czml_points_sample.czml:', error);
        });

        // 添加Cesium OSM Buildings
        var osmBuildingsTileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: Cesium.IonResource.fromAssetId(96188)
        }));
    }
</script>
</body>
</html>
